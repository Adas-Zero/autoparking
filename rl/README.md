# openAI gym custom environment  
Adas-one에서 지원을 받아 진행한 자율주차 프로젝트의 강화학습 파트입니다.  
주차 칸 앞에 차량이 위치하면 강화학습 신경망을 통해 학습된 경로로 이동하도록 동작을 결정합니다.  

## Contents  
1. 개발 진행 사항  
2. 기술 스택 및 용도  
3. 문제 해결  
4. 아쉬웠던 점 및 개선 목표  
---
### 1. 개발 진행 사항  

#### action 정의  
LEFTFORWARD / CENTERFORWARD / RIGHTFORWARD  
LEFTBACKWARD / CENTERBACKWARD / RIGHTBACKWARD  
총 6개 액션으로 정의  
LEFT : steer 30도 회전 / RIGHT : steer -30도 회전  
FORWARD : wheel effort += 100 / BACKWARD : wheel effort -= 100 (-100 ~ 100 사이 일때만)  
  
#### state 정의  
[차량 4점(x,y), 주차칸 4점(x,y), wheel_effort, steer, frame] - 총 19개 값  
  
#### 보상 정책  
x = 차량 4점과 상응하는 주차칸 4점 각 점 사이의 거리^2 합  
reward = -16*log(x/16) (선형적으로 주는 것보다 가까워졌을 때 주는 보상 극대화 가능)

reward -= frame *0.001 (빠른 경로에 가산점 주기 위함)  
벽, 차선 충돌 시 reward -= 10 (*고정값으로 주면 주차칸 근처에서 죽었을 때랑 벽에서 죽었을 때 차이 X)  
  
### 2. 기술 스택 및 용도  
- 환경  
python2.7 / Ubuntu 18.04
- 시뮬레이터 환경 제작 
ROS-melodic  
gazebo  
- gym class 구현  
openai gym  
- DQN 구현  
pytorch  
  
### 3. 문제 해결  
#### - 시뮬레이터에서 차량 4점 위치 받아오기  
가제보 시뮬레이터에서 받아올 수 있는 정보는 차량 오브젝트의 기준점 한 점과 방향 정보 뿐  
-> 방향축 기준으로 뒤로 일정 간격, 앞으로 일정 간격 이동시킨 다음 방향축과 수직으로 (차량 가로 크기/2) 만큼 좌우로 이동시켜 4점 정보 획득  

#### - 충돌 감지  
기존에 사용되던 상태 입력 방식은 차선, 차량, 배경, 주차칸으로 세그멘테이션 된 AVM 영상이 주어지는 방식  
하지만 비젼 파트에서 오버헤드가 커짐에 따라, 정해진 주차칸 4점 좌표와 AVM영상에서 차량 4점 정보만 받아서 상태를 결정하는 방식으로 변경  
-> 충돌 감지 :  
1) 차량의 한 점이 차선 좌표를 넘어가는 경우 (이 때, 주차칸은 무조건 기울어지지 않았다고 가정)
주차칸이 상/하/좌/우 인 경우 나눠서 고려  
ex)주차칸이 왼쪽인 경우 - 차량의 한 점의 x값이 주차칸 앞쪽 점의 x좌표보다 작으면서 y좌표가 위쪽 주차칸 점보다 높거나, 아래쪽 주차칸 점보다 낮으면 충돌  
2) 주차칸의 한 점이 차량 4점 사이에 있는 경우(너무 엄밀한 조건이라 아직 적용 X)  
차량의 각 변과 주차칸의 한 점이 이루는 삼각형 4개의 넓이 합 == 차량 넓이(가로길이 * 세로길이)이면 충돌  
  
### 4. 아쉬웠던 점 및 개선 목표  
1) 초기 시작위치 랜덤화  
2) 시뮬레이터 가속화  
3) 학습에 가이드라인을 주는 방법 연구
4) 시간이 좀 더 있었다면...
